<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat App â€“ Real-Time Messaging</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <style>
    #typingStatus {
      font-style: italic;
      color: #888;
      margin-top: 5px;
    }
    .private-message {
      background-color: #ffe0e0;
      padding: 5px;
      border-radius: 6px;
      margin: 5px 0;
    }
    .room-message {
      background-color: #e0f7ff;
      padding: 5px;
      border-radius: 6px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="darkToggle">ğŸŒ™ Toggle Dark Mode</button>
    <h2>ğŸ’¬ Chat Room</h2>

    <div id="userInfo">
      ğŸ‘¤ Logged in as: <span id="currentUserDisplay"></span>
      <button id="logoutBtn">ğŸšª Logout</button>
    </div>

    <h3>ğŸŸ¢ Online Users</h3>
    <ul id="onlineList"></ul>

    <!-- ğŸ”’ Private Messaging UI -->
    <h3>ğŸ“© Send Private Message</h3>
    <select id="privateUserSelect">
      <option value="">--Select User--</option>
    </select>
    <div class="input-area" style="margin-top: 5px;">
      <input type="text" id="privateMessageInput" placeholder="Type a private message..." />
      <button id="sendPrivateBtn">Send Private</button>
    </div>

    <!-- ğŸ  Room Messaging UI -->
    <h3>ğŸ  Join Room</h3>
    <select id="roomSelect">
      <option value="">--Choose Room--</option>
      <option value="sports">Sports</option>
      <option value="tech">Tech</option>
      <option value="music">Music</option>
    </select>
    <div class="input-area" style="margin-top: 5px;">
      <input type="text" id="roomMessageInput" placeholder="Type a room message..." />
      <button id="sendRoomBtn">Send to Room</button>
    </div>

    <div id="loading">â³ Loading messages...</div>
    <div id="messages"></div>
    <div id="typingStatus"></div>

    <!-- ğŸŒ Public Chat -->
    <div class="input-area">
      <input id="msgInput" type="text" placeholder="Type your message..." />
      <button onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
      <button onclick="insertEmoji('ğŸ‰')">ğŸ‰</button>
      <button onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</button>
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    const socket = io("http://localhost:5050", {
  auth: {
    token: localStorage.getItem("token"),
  }
});
    socket.on("connect_error", (err) => {
      console.error("Connection error:", err);
      alert("You must be logged in to access the chat.");
      localStorage.clear();
      window.location.href = "index.html"; // Redirect to login
    });

    const currentUser = localStorage.getItem("username") || "Guest";
    document.getElementById("currentUserDisplay").textContent = currentUser;

    // DOM Elements
    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("msgInput");
    const typingStatus = document.getElementById("typingStatus");
    const privateUserSelect = document.getElementById("privateUserSelect");
    const privateMessageInput = document.getElementById("privateMessageInput");
    const sendPrivateBtn = document.getElementById("sendPrivateBtn");
    const roomSelect = document.getElementById("roomSelect");
    const roomInput = document.getElementById("roomMessageInput");
    const sendRoomBtn = document.getElementById("sendRoomBtn");

    // Focus input on load
    input.focus();
    

    // âœ… Load public messages
    window.addEventListener("DOMContentLoaded", async () => {
      const res = await fetch("http://localhost:5050/api/messages", {
  headers: {
    Authorization: `Bearer ${localStorage.getItem("token")}`
  }
});

      const messages = await res.json();
      document.getElementById("loading").style.display = "none";
      messages.forEach(appendMessage);
    });

    // âœ… Send public message
    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      socket.emit("sendMessage", { username: currentUser, text });
      input.value = "";
      input.focus();
      socket.emit("stopTyping");
    }

    // âœ… Display public message
    function appendMessage(data) {
      const msg = document.createElement("div");
      msg.className = data.username === currentUser ? "message self" : "message";
      const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      msg.innerHTML = `<strong>${data.username}</strong>: ${data.text} <span class="timestamp">${time}</span>`;
      messagesDiv.appendChild(msg);
    }

    socket.on("receiveMessage", appendMessage);

    // âœ… Typing Indicator
    let typingTimeout;
    input.addEventListener("input", () => {
      socket.emit("typing");
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => socket.emit("stopTyping"), 1000);
    });

    socket.on("userTyping", (username) => {
      if (username !== currentUser) typingStatus.textContent = `${username} is typing...`;
    });

    socket.on("userStoppedTyping", () => typingStatus.textContent = "");

    // âœ… Private Messaging
    sendPrivateBtn.addEventListener("click", () => {
      const selectedUser = privateUserSelect.value;
      const message = privateMessageInput.value.trim();
      if (!selectedUser || !message) return;
      socket.emit("privateMessage", { from: currentUser, to: selectedUser, message });
      displayPrivateMessage({ from: currentUser, to: selectedUser, message, timestamp: new Date() });
      privateMessageInput.value = "";
    });

    socket.on("receivePrivateMessage", displayPrivateMessage);

    function displayPrivateMessage(data) {
      const div = document.createElement("div");
      div.className = "private-message";
      const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const label = data.from === currentUser ? `To ${data.to}` : `From ${data.from}`;
      div.innerHTML = `<strong>ğŸ”’ ${label}:</strong> ${data.message} <span class="timestamp">${time}</span>`;
      messagesDiv.appendChild(div);
    }

    // âœ… Room Messaging
    let currentRoom = "";

    roomSelect.addEventListener("change", () => {
      const room = roomSelect.value;
      if (!room) return;
      currentRoom = room;
      messagesDiv.innerHTML = ""; // âœ… Clear previous messages
      socket.emit("joinRoom", { username: currentUser, room });
    });

    socket.on("roomHistory", (history) => {
      messagesDiv.innerHTML += `<hr/><strong>ğŸ“š Room History:</strong><br/>`;
      history.forEach(msg => displayRoomMessage(msg));
    });

    sendRoomBtn.addEventListener("click", () => {
      const text = roomInput.value.trim();
      if (!currentRoom || !text) return;
      socket.emit("roomMessage", { username: currentUser, room: currentRoom, text });
      roomInput.value = "";
    });

    socket.on("roomMessage", displayRoomMessage);

    function displayRoomMessage(data) {
      const div = document.createElement("div");
      div.className = "room-message";
      const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = `<strong>ğŸ  ${data.room} | ${data.username}:</strong> ${data.text} <span class="timestamp">${time}</span>`;
      messagesDiv.appendChild(div);
    }

      

    // âœ… Update Online User List
    socket.on("updateUsers", (users) => {
      const onlineList = document.getElementById("onlineList");
      privateUserSelect.innerHTML = '<option value="">--Select User--</option>';
      onlineList.innerHTML = "";

      users.forEach(user => {
        const li = document.createElement("li");
        li.textContent = user;
        onlineList.appendChild(li);
        if (user !== currentUser) {
          const option = document.createElement("option");
          option.value = user;
          option.textContent = user;
          privateUserSelect.appendChild(option);
        }
      });
    });

    // âœ… Logout and Dark Mode
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    const toggleBtn = document.getElementById("darkToggle");
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    });

    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
    }

    // âœ… Enter Key Shortcuts
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });
    privateMessageInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendPrivateBtn.click(); });
    roomInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendRoomBtn.click(); });

  //     socket.emit("getRoomHistory", roomName, (messages) => {
  // // Display messages
  // });


    // âœ… Emoji Insertion
    function insertEmoji(emoji) {
      input.value += emoji;
      input.focus();
    }
  </script>
</body>
</html>
